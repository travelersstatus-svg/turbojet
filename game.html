<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aviator - Complete Fix</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        :root { --bg: #0a0e17; --card: #161d2b; --green: #28a745; --red: #d11348; --gold: #d97706; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', Arial, sans-serif; margin: 0; overflow: hidden; user-select: none; }
        .header { background: #0f1521; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #252f44; }
        .balance-pill { background: #000; border: 2px solid var(--green); padding: 5px 15px; border-radius: 20px; color: var(--green); font-weight: bold; font-size: 18px; }
        .display-box { position: relative; height: 280px; margin: 10px; background: radial-gradient(circle at bottom left, #1c2c4c 0%, #05080f 85%); border-radius: 15px; border: 1px solid #252f44; overflow: hidden; }
        #mult-val { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 4rem; font-weight: 900; z-index: 10; text-shadow: 0 0 20px rgba(255,255,255,0.2); }
        #flew-msg { position: absolute; top: 30%; left: 50%; transform: translateX(-50%); color: var(--red); font-size: 1.5rem; font-weight: bold; display: none; z-index: 11; }
        canvas { width: 100%; height: 100%; }
        .bet-area { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
        .bet-panel { background: var(--card); padding: 15px; border-radius: 15px; border: 1px solid #252f44; text-align: center; }
        .num-input { width: 100%; background: #000; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 8px; margin-bottom: 10px; text-align: center; font-size: 18px; box-sizing: border-box; }
        .action-btn { width: 100%; height: 50px; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; color: white; transition: 0.2s; }
        .btn-bet { background: var(--green); }
        .btn-cash { background: var(--gold); }
        .btn-wait { background: #333; cursor: not-allowed; }
        #side-panel { position: fixed; top: 0; right: -100%; width: 85%; height: 100%; background: #0f1521; z-index: 1000; transition: 0.4s; padding: 20px; box-shadow: -5px 0 15px rgba(0,0,0,0.5); }
        .menu-open { right: 0 !important; }
    </style>
</head>
<body>

<div id="side-panel">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="color:var(--red);">MENU</h2>
        <button onclick="toggleSidebar()" style="background:none; border:none; color:white; font-size:32px;">×</button>
    </div>
    <div style="margin-top:20px; background:var(--card); padding:15px; border-radius:12px; border:1px solid #252f44;">
        <p><b>DEPOSIT FUNDS</b></p>
        <input type="number" id="d-amount" placeholder="Amount (₹)" class="num-input">
        <input type="text" id="d-utr-code" placeholder="Enter UTR/Reference No" class="num-input">
        <button onclick="submitDepToAdmin()" class="action-btn btn-bet">SUBMIT TO ADMIN</button>
    </div>
</div>

<div class="header">
    <div style="color:#ff0055; font-weight:900; font-size:24px; letter-spacing:1px;">AVIATOR</div>
    <div style="display:flex; align-items:center; gap:12px;">
        <div class="balance-pill">₹<span id="wall-bal">0.00</span></div>
        <div onclick="toggleSidebar()" style="cursor:pointer; font-size:30px;">☰</div>
    </div>
</div>

<div class="display-box">
    <div id="mult-val">1.00x</div>
    <div id="flew-msg">FLEW AWAY!</div>
    <canvas id="aviCanvas"></canvas>
</div>

<div class="bet-area">
    <div class="bet-panel">
        <input type="number" id="amt-val-1" value="100" class="num-input">
        <button id="btn-ctrl-1" class="action-btn btn-bet" onclick="handleBet(1)">BET</button>
    </div>
    <div class="bet-panel">
        <input type="number" id="amt-val-2" value="100" class="num-input">
        <button id="btn-ctrl-2" class="action-btn btn-bet" onclick="handleBet(2)">BET</button>
    </div>
</div>

<script>
    const firebaseConfig = { 
        apiKey: "AIzaSyCrk8ksYM1Kt6ehT0TkDr3vjybjHDCyDgc", 
        authDomain: "myaviatoregame.firebaseapp.com", 
        projectId: "myaviatoregame", 
        databaseURL: "https://myaviatoregame-default-rtdb.firebaseio.com",
        appId: "1:286687400349:web:e01e2cff439a3267de1f74" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let balance = 0, multiplier = 1.0, gameState = "betting"; 
    let activeBets = { 1: null, 2: null };

    const canvas = document.getElementById('aviCanvas');
    const ctx = canvas.getContext('2d');
    const plane = new Image();
    plane.src = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBkPSJNMzIgMjU2TDE2MCAxOTJMMjI0IDMyLDI4OCAxOTJMNTAwIDI1NkwyODggMzI0TDIyNCA0ODBMMTYwIDMyNEwzMiAyNTZ6IiBmaWxsPSIjZmYwMDQ0Ii8+PC9zdmc+";

    function toggleSidebar() { document.getElementById('side-panel').classList.toggle('menu-open'); }

    // FIXED DEPOSIT FUNCTION
    function submitDepToAdmin() {
        let a = document.getElementById('d-amount').value;
        let u = document.getElementById('d-utr-code').value;
        if(!a || !u) return alert("Fill Amount and UTR!");
        
        db.ref('requests/deposits').push({
            uid: auth.currentUser.uid,
            email: auth.currentUser.email,
            amount: parseFloat(a),
            utr: u,
            status: 'pending',
            time: Date.now()
        }).then(() => {
            alert("Request sent! Admin will approve soon.");
            toggleSidebar();
        });
    }

    function handleBet(p) {
        let amt = parseFloat(document.getElementById('amt-val-'+p).value);
        if (gameState === "betting") {
            if (activeBets[p]) { balance += activeBets[p].amt; activeBets[p] = null; }
            else if (amt <= balance) { balance -= amt; activeBets[p] = { amt: amt, cashed: false }; }
        } else if (gameState === "flying" && activeBets[p] && !activeBets[p].cashed) {
            balance += (activeBets[p].amt * multiplier);
            activeBets[p].cashed = true;
        }
        db.ref('users/' + auth.currentUser.uid).update({ balance: balance });
        updateDisplay();
    }

    function updateDisplay() {
        document.getElementById('wall-bal').innerText = balance.toFixed(2);
        [1, 2].forEach(p => {
            let btn = document.getElementById('btn-ctrl-'+p);
            if (gameState === "betting") {
                btn.className = "action-btn " + (activeBets[p] ? "btn-wait" : "btn-bet");
                btn.innerText = activeBets[p] ? "CANCEL" : "BET";
            } else if (gameState === "flying") {
                if (activeBets[p] && !activeBets[p].cashed) {
                    btn.className = "action-btn btn-cash";
                    btn.innerText = "CASH OUT ₹" + (activeBets[p].amt * multiplier).toFixed(1);
                } else { btn.className = "action-btn btn-wait"; btn.innerText = "WAITING..."; }
            } else { btn.className = "action-btn btn-wait"; btn.innerText = "CRASHED"; }
        });
    }

    function initRound() {
        gameState = "betting"; multiplier = 1.0;
        document.getElementById('mult-val').style.color = "white";
        document.getElementById('flew-msg').style.display = "none";
        let waitTime = 5;
        let t = setInterval(() => {
            document.getElementById('mult-val').innerText = "Next Round: " + waitTime + "s";
            waitTime--;
            if (waitTime < 0) { clearInterval(t); launchPlane(); }
        }, 1000);
        updateDisplay();
    }

    function launchPlane() {
        gameState = "flying";
        let crashPoint = (1.0 + Math.pow(Math.random(), 4) * 12).toFixed(2);
        let move = setInterval(() => {
            if (multiplier >= crashPoint) {
                clearInterval(move);
                gameState = "crashed";
                document.getElementById('mult-val').style.color = "#ff0055";
                document.getElementById('flew-msg').style.display = "block";
                activeBets = { 1: null, 2: null };
                updateDisplay();
                setTimeout(initRound, 4000);
                return;
            }
            multiplier += (multiplier < 3 ? 0.01 : 0.04);
            document.getElementById('mult-val').innerText = multiplier.toFixed(2) + "x";
            renderCanvas();
            updateDisplay();
        }, 65);
    }

    function renderCanvas() {
        canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight;
        let p = Math.min((multiplier - 1) / 6, 0.9);
        let x = p * canvas.width * 0.85 + 40, y = (canvas.height - 40) - (Math.pow(p, 0.65) * canvas.height * 0.75);
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.strokeStyle = "#ff0055"; ctx.lineWidth = 6; ctx.beginPath();
        ctx.moveTo(0, canvas.height); ctx.quadraticCurveTo(x/2, canvas.height, x, y); ctx.stroke();
        ctx.drawImage(plane, x-30, y-30, 60, 60);
    }

    auth.onAuthStateChanged(user => {
        if(!user) window.location.href = "index.html";
        else db.ref('users/'+user.uid+'/balance').on('value', s => { balance = s.val() || 0; updateDisplay(); });
    });
    plane.onload = initRound;
</script>
</body>
</html>

