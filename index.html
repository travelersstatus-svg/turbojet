<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aviator Pro Max - Final Fixed</title>
    
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendEmailVerification, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      // --- APKA CONFIG ---
      const firebaseConfig = {
        apiKey: "AIzaSyCrk8ksYM1Kt6ehT0TkDr3vjybjHDCyDgc",
        authDomain: "myaviatoregame.firebaseapp.com",
        projectId: "myaviatoregame",
        storageBucket: "myaviatoregame.firebasestorage.app",
        messagingSenderId: "286687400349",
        appId: "1:286687400349:web:e01e2cff439a3267de1f74"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth();
      const db = getFirestore();

      window.isLoginMode = true;
      window.wallet = 0; // Initial

      // --- AUTH LOGIC ---
      window.toggleAuthMode = () => {
        window.isLoginMode = !window.isLoginMode;
        document.getElementById('auth-title').innerText = window.isLoginMode ? "LOGIN" : "REGISTER";
        document.getElementById('auth-switch').innerText = window.isLoginMode ? "Don't have an account? Register" : "Already have an account? Login";
      };

      window.handleAuth = async () => {
        const email = document.getElementById('auth-email').value;
        const pass = document.getElementById('auth-pass').value;
        if(!email || pass.length < 6) return alert("Enter valid Email & Password (min 6 chars)");

        try {
          if (window.isLoginMode) {
            const res = await signInWithEmailAndPassword(auth, email, pass);
            if (res.user.emailVerified) {
                document.getElementById('auth-screen').style.display = 'none';
                startBalanceListener(res.user.uid);
            } else {
                alert("Please verify your email! Check your inbox.");
                await signOut(auth);
            }
          } else {
            const res = await createUserWithEmailAndPassword(auth, email, pass);
            await sendEmailVerification(res.user);
            // Create user doc in DB
            await setDoc(doc(db, "users", res.user.uid), { balance: 0, email: email });
            alert("Verification link sent! Verify and then Login.");
            window.toggleAuthMode();
            await signOut(auth);
          }
        } catch (err) { alert(err.message); }
      };

      // --- REAL-TIME SYNC ---
      function startBalanceListener(uid) {
        onSnapshot(doc(db, "users", uid), (docSnap) => {
          if (docSnap.exists()) {
            window.wallet = docSnap.data().balance;
            document.getElementById('bal-text').innerText = window.wallet.toFixed(2);
          }
        });
      }

      // --- GAME ACTIONS ---
      window.handleBet = async (p) => {
        const amt = parseFloat(document.getElementById('amt-' + p).value);
        if(amt > window.wallet || amt <= 0) return alert("Invalid Balance/Amount");

        try {
          // Subtract locally for speed
          const newBal = window.wallet - amt;
          // Update in Firebase for security
          await updateDoc(doc(db, "users", auth.currentUser.uid), { balance: newBal });
          alert("Bet Placed: ₹" + amt);
        } catch (e) {
          alert("Error placing bet. Try again.");
        }
      };

      window.submitDeposit = async () => {
          const amt = document.getElementById('d-amt').value;
          const utr = document.getElementById('d-utr').value;
          if(!amt || utr.length < 12) return alert("Enter Amount & 12-digit UTR");
          await addDoc(collection(db, "deposits"), { 
              uid: auth.currentUser.uid, 
              email: auth.currentUser.email, 
              amt: parseFloat(amt), 
              utr: utr, 
              time: new Date(),
              status: "pending" 
          });
          alert("Deposit request sent to Admin!");
          document.getElementById('dep-modal').style.display = 'none';
      };

      onAuthStateChanged(auth, (user) => {
        if (user && user.emailVerified) {
            document.getElementById('auth-screen').style.display = 'none';
            startBalanceListener(user.uid);
        }
      });
    </script>

    <style>
        :root { --bg-dark: #0a0e17; --panel-bg: #161d2b; --win-green: #28a745; --accent-red: #d11348; --btn-orange: #d97706; --text-gray: #9ea0a3; }
        body { background: var(--bg-dark); color: white; font-family: sans-serif; margin: 0; padding: 0; overflow: hidden; }
        #auth-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-dark); z-index: 10000; display: flex; justify-content: center; align-items: center; }
        .auth-card { background: var(--panel-bg); padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; border: 1px solid #252f44; }
        .top-nav { background: #0f1521; padding: 12px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #252f44; }
        .balance-box { background: #000; border: 2px solid var(--win-green); padding: 6px 18px; border-radius: 20px; color: var(--win-green); font-weight: bold; cursor: pointer; }
        .display-area { position: relative; height: 250px; background: radial-gradient(circle at bottom left, #1a2a44 0%, #05080f 70%); margin: 10px; border-radius: 15px; overflow: hidden; border: 1px solid #252f44; display: flex; align-items: center; justify-content: center; }
        #multiplier-text { font-size: 3.5rem; font-weight: 900; color: white; text-shadow: 0 0 20px rgba(255,255,255,0.5); }
        .bet-container { display: flex; gap: 8px; padding: 10px; }
        .bet-card { background: var(--panel-bg); padding: 15px; border-radius: 15px; width: 50%; border: 1px solid #252f44; }
        .main-btn { width: 100%; padding: 12px; border: none; border-radius: 10px; background: var(--win-green); color: white; font-weight: bold; cursor: pointer; }
        .modal-input { width: 90%; padding: 10px; margin: 10px 0; background: #000; border: 1px solid #333; color: #fff; border-radius: 5px; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9000; justify-content: center; align-items: center; }
    </style>
</head>
<body>

<div id="auth-screen">
    <div class="auth-card">
        <h2 id="auth-title" style="color:#ff0055">LOGIN</h2>
        <input type="email" id="auth-email" class="modal-input" placeholder="Email Address">
        <input type="password" id="auth-pass" class="modal-input" placeholder="Password">
        <button class="main-btn" onclick="handleAuth()">PROCEED</button>
        <p id="auth-switch" onclick="toggleAuthMode()" style="cursor:pointer; font-size:12px; margin-top:10px; color: var(--text-gray);">Don't have an account? Register</p>
    </div>
</div>

<div class="top-nav">
    <div style="color:#ff0055; font-weight:900; font-size:20px;">AVIATOR</div>
    <div class="balance-box" onclick="document.getElementById('dep-modal').style.display='flex'">₹<span id="bal-text">0.00</span></div>
</div>

<div class="display-area">
    <div id="multiplier-text">1.00x</div>
</div>

<div class="bet-container">
    <div class="bet-card">
        <input type="number" id="amt-1" value="100" class="modal-input" style="width: 80%;">
        <button id="btn-1" class="main-btn" onclick="handleBet(1)">BET</button>
    </div>
    <div class="bet-card">
        <input type="number" id="amt-2" value="100" class="modal-input" style="width: 80%;">
        <button id="btn-2" class="main-btn" onclick="handleBet(2)">BET</button>
    </div>
</div>

<div id="dep-modal" class="modal-overlay">
    <div class="auth-card">
        <h3>Deposit Money</h3>
        <p style="font-size: 12px; color: #999;">Pay to UPI: <b>example@upi</b></p>
        <input type="number" id="d-amt" class="modal-input" placeholder="Amount">
        <input type="text" id="d-utr" class="modal-input" placeholder="12 Digit UTR Number">
        <button class="main-btn" onclick="submitDeposit()">Submit Request</button>
        <button class="main-btn" style="background:#444; margin-top:5px;" onclick="document.getElementById('dep-modal').style.display='none'">Close</button>
    </div>
</div>

</body>
</html>
